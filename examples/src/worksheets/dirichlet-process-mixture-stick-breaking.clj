;; gorilla-repl.fileformat = 1

;; **
;;; # Dirichlet Process Mixture Model - stick breaking construction
;; **

;; @@
(ns worksheets.dirichlet-process-mixture-stick-breaking
  (:require [anglican.runtime :refer :all]
            [anglican.emit :refer [defquery with-primitive-procedures defm]]
            [anglican.stat :refer [empirical-distribution collect-predicts collect-by collect-results]]
            [anglican.core :refer [doquery]]
            [anglican.state :refer [get-predicts]]
            [anglican.infcomp.zmq :as zmq]
            anglican.infcomp.csis
            anglican.importance
            anglican.smc
            anglican.pgibbs
            anglican.infcomp.core
            [anglican.infcomp.dists :refer :all]
            [anglican.infcomp.prior :as prior]
            [anglican.inference :refer [infer]]
            [helpers.gmm :refer [normalize move-to-unit-box gridify]]
            [gorilla-plot.core :as plt]))

(anglican.infcomp.core/reset-infcomp-addressing-scheme!)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#function[anglican.infcomp.core/reset-infcomp-addressing-scheme!$fn--27296$fn--27297]</span>","value":"#function[anglican.infcomp.core/reset-infcomp-addressing-scheme!$fn--27296$fn--27297]"}
;; <=

;; **
;;; ## Model
;; **

;; @@
(defm create-sethuraman-stick-breaking-process
  [concentration]
  (let
    [
      ; sethuraman-stick-breaking-rule returns 
      ; a stick length via the one-parameter 
      ; stick breaking rule which closes
      ; over concentration
      sethuraman-stick-breaking-rule 
      (mem (fn [k] (sample* (beta 1 concentration))))

      ; sample-stick-index is a procedure that 
      ; samples an index from a potentially 
      ; infinite dimensional discrete distribution 
      ; lazily constructed by a stick breaking rule
      sample-stick-index 
      (fn sample-stick-index [k] 
        (if (sample* (flip (sethuraman-stick-breaking-rule k))) 
          k 
          (sample-stick-index (+ k 1))))

      ; wrapping a stick breaking process to return it
      stick-breaking-process 
      (fn [] (sample-stick-index 1))]
    stick-breaking-process))

(defm DPmem
  "DPmem is a procedure that takes two arguments -- 
  the concentration to a Dirichlet process
  and a base sampling procedure. DPmem returns a procedure."
  [concentration base]
  (let [get-value-from-cache-or-sample 
        (mem 
          (fn [args stick-index] 
            (apply base args)))
        get-stick-picking-procedure-from-cache 
        (mem 
          (fn [args] 
            (create-sethuraman-stick-breaking-process 
              concentration)))]
    (fn [& varargs]
      ; when the returned function is called, 
      ; the first thing it does is get
      ; the cached stick breaking procedure 
      ; for the passed in arguments
      ; and _calls_ it to get an index
      (let [index ((get-stick-picking-procedure-from-cache 
                     varargs))]
        ; if, for the given set of arguments 
        ; and just sampled index a return value has already 
        ; been computed, get it from the cache
        ; and return it, otherwise sample a new value
        (get-value-from-cache-or-sample varargs index)))))

(defquery dirichlet-process-mixture-stick-breaking
  [input-data]
  (let
    [concentration 1.72
     base (fn []
            (let [v (/ 1.0 (sample (gamma 1 10)))]
              (list (sample (normal 0 (sqrt (* v 10)))) 
                    (sqrt v))))
     obs-param (DPmem concentration base)]

    ; observe draws from the DP mixture
    (map
      (fn [value]
        (observe (apply normal (obs-param)) value))
      input-data)

    ; predict a data point from the DP mixture
    (sample (apply normal (obs-param)))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/dirichlet-process-mixture-stick-breaking</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/dirichlet-process-mixture-stick-breaking"}
;; <=

;; **
;;; ## Inference Compilation
;; **

;; @@
(prior/sample-samples-from-prior dirichlet-process-mixture-stick-breaking [(repeat 8 nil)])
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:time-index 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x7ef9c2e7 &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@7ef9c2e7&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x7ef9c2e7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@7ef9c2e7\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x7ef9c2e7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@7ef9c2e7\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.055508551459436034</span>","value":"0.055508551459436034"}],"value":"[:value 0.055508551459436034]"}],"value":"{:time-index 0, :sample-address \"S65\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x7ef9c2e7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@7ef9c2e7\"], :value 0.055508551459436034}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:time-index 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x3f6b0cd1 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@3f6b0cd1&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x3f6b0cd1 \"anglican.infcomp.flatbuffers.normal.NormalClj@3f6b0cd1\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x3f6b0cd1 \"anglican.infcomp.flatbuffers.normal.NormalClj@3f6b0cd1\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>10.158773322930738</span>","value":"10.158773322930738"}],"value":"[:value 10.158773322930738]"}],"value":"{:time-index 1, :sample-address \"S61\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x3f6b0cd1 \"anglican.infcomp.flatbuffers.normal.NormalClj@3f6b0cd1\"], :value 10.158773322930738}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:time-index 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:sample-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xd168dde &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@d168dde&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xd168dde \"anglican.infcomp.flatbuffers.gamma.GammaClj@d168dde\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xd168dde \"anglican.infcomp.flatbuffers.gamma.GammaClj@d168dde\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.1493620348729067</span>","value":"0.1493620348729067"}],"value":"[:value 0.1493620348729067]"}],"value":"{:time-index 2, :sample-address \"S65\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xd168dde \"anglican.infcomp.flatbuffers.gamma.GammaClj@d168dde\"], :value 0.1493620348729067}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>3</span>","value":"3"}],"value":"[:time-index 3]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>1</span>","value":"1"}],"value":"[:sample-instance 1]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x43bbf088 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@43bbf088&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x43bbf088 \"anglican.infcomp.flatbuffers.normal.NormalClj@43bbf088\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x43bbf088 \"anglican.infcomp.flatbuffers.normal.NormalClj@43bbf088\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>1.2252073067844813</span>","value":"1.2252073067844813"}],"value":"[:value 1.2252073067844813]"}],"value":"{:time-index 3, :sample-address \"S61\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x43bbf088 \"anglican.infcomp.flatbuffers.normal.NormalClj@43bbf088\"], :value 1.2252073067844813}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>4</span>","value":"4"}],"value":"[:time-index 4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:sample-instance 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x67ac9375 &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@67ac9375&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x67ac9375 \"anglican.infcomp.flatbuffers.gamma.GammaClj@67ac9375\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x67ac9375 \"anglican.infcomp.flatbuffers.gamma.GammaClj@67ac9375\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.0939669083042041</span>","value":"0.0939669083042041"}],"value":"[:value 0.0939669083042041]"}],"value":"{:time-index 4, :sample-address \"S65\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x67ac9375 \"anglican.infcomp.flatbuffers.gamma.GammaClj@67ac9375\"], :value 0.0939669083042041}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>5</span>","value":"5"}],"value":"[:time-index 5]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>2</span>","value":"2"}],"value":"[:sample-instance 2]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x73051b7f &quot;anglican.infcomp.flatbuffers.normal.NormalClj@73051b7f&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x73051b7f \"anglican.infcomp.flatbuffers.normal.NormalClj@73051b7f\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x73051b7f \"anglican.infcomp.flatbuffers.normal.NormalClj@73051b7f\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-6.543903166024701</span>","value":"-6.543903166024701"}],"value":"[:value -6.543903166024701]"}],"value":"{:time-index 5, :sample-address \"S61\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x73051b7f \"anglican.infcomp.flatbuffers.normal.NormalClj@73051b7f\"], :value -6.543903166024701}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>6</span>","value":"6"}],"value":"[:time-index 6]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S65&quot;</span>","value":"\"S65\""}],"value":"[:sample-address \"S65\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>3</span>","value":"3"}],"value":"[:sample-instance 3]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x545069d7 &quot;anglican.infcomp.flatbuffers.gamma.GammaClj@545069d7&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x545069d7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@545069d7\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x545069d7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@545069d7\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>0.05885346337468968</span>","value":"0.05885346337468968"}],"value":"[:value 0.05885346337468968]"}],"value":"{:time-index 6, :sample-address \"S65\", :sample-instance 3, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x545069d7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@545069d7\"], :value 0.05885346337468968}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>7</span>","value":"7"}],"value":"[:time-index 7]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S61&quot;</span>","value":"\"S61\""}],"value":"[:sample-address \"S61\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>3</span>","value":"3"}],"value":"[:sample-instance 3]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x6b54cd7f &quot;anglican.infcomp.flatbuffers.normal.NormalClj@6b54cd7f&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0x6b54cd7f \"anglican.infcomp.flatbuffers.normal.NormalClj@6b54cd7f\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x6b54cd7f \"anglican.infcomp.flatbuffers.normal.NormalClj@6b54cd7f\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-16.687578813298114</span>","value":"-16.687578813298114"}],"value":"[:value -16.687578813298114]"}],"value":"{:time-index 7, :sample-address \"S61\", :sample-instance 3, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x6b54cd7f \"anglican.infcomp.flatbuffers.normal.NormalClj@6b54cd7f\"], :value -16.687578813298114}"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:time-index</span>","value":":time-index"},{"type":"html","content":"<span class='clj-unkown'>8</span>","value":"8"}],"value":"[:time-index 8]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-address</span>","value":":sample-address"},{"type":"html","content":"<span class='clj-string'>&quot;S46&quot;</span>","value":"\"S46\""}],"value":"[:sample-address \"S46\"]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:sample-instance</span>","value":":sample-instance"},{"type":"html","content":"<span class='clj-unkown'>0</span>","value":"0"}],"value":"[:sample-instance 0]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:distribution</span>","value":":distribution"},{"type":"html","content":"<span class='clj-unkown'>#object[anglican.infcomp.flatbuffers.normal.NormalClj 0xc7f83e6 &quot;anglican.infcomp.flatbuffers.normal.NormalClj@c7f83e6&quot;]</span>","value":"#object[anglican.infcomp.flatbuffers.normal.NormalClj 0xc7f83e6 \"anglican.infcomp.flatbuffers.normal.NormalClj@c7f83e6\"]"}],"value":"[:distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0xc7f83e6 \"anglican.infcomp.flatbuffers.normal.NormalClj@c7f83e6\"]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:value</span>","value":":value"},{"type":"html","content":"<span class='clj-double'>-8.466721952882857</span>","value":"-8.466721952882857"}],"value":"[:value -8.466721952882857]"}],"value":"{:time-index 8, :sample-address \"S46\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0xc7f83e6 \"anglican.infcomp.flatbuffers.normal.NormalClj@c7f83e6\"], :value -8.466721952882857}"}],"value":"[{:time-index 0, :sample-address \"S65\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x7ef9c2e7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@7ef9c2e7\"], :value 0.055508551459436034} {:time-index 1, :sample-address \"S61\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x3f6b0cd1 \"anglican.infcomp.flatbuffers.normal.NormalClj@3f6b0cd1\"], :value 10.158773322930738} {:time-index 2, :sample-address \"S65\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0xd168dde \"anglican.infcomp.flatbuffers.gamma.GammaClj@d168dde\"], :value 0.1493620348729067} {:time-index 3, :sample-address \"S61\", :sample-instance 1, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x43bbf088 \"anglican.infcomp.flatbuffers.normal.NormalClj@43bbf088\"], :value 1.2252073067844813} {:time-index 4, :sample-address \"S65\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x67ac9375 \"anglican.infcomp.flatbuffers.gamma.GammaClj@67ac9375\"], :value 0.0939669083042041} {:time-index 5, :sample-address \"S61\", :sample-instance 2, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x73051b7f \"anglican.infcomp.flatbuffers.normal.NormalClj@73051b7f\"], :value -6.543903166024701} {:time-index 6, :sample-address \"S65\", :sample-instance 3, :distribution #object[anglican.infcomp.flatbuffers.gamma.GammaClj 0x545069d7 \"anglican.infcomp.flatbuffers.gamma.GammaClj@545069d7\"], :value 0.05885346337468968} {:time-index 7, :sample-address \"S61\", :sample-instance 3, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0x6b54cd7f \"anglican.infcomp.flatbuffers.normal.NormalClj@6b54cd7f\"], :value -16.687578813298114} {:time-index 8, :sample-address \"S46\", :sample-instance 0, :distribution #object[anglican.infcomp.flatbuffers.normal.NormalClj 0xc7f83e6 \"anglican.infcomp.flatbuffers.normal.NormalClj@c7f83e6\"], :value -8.466721952882857}]"}
;; <=

;; @@
(defn combine-observes-fn [observes]
  (gridify (move-to-unit-box (map #(/ (:value %) 50) observes)) [30]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/combine-observes-fn</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/combine-observes-fn"}
;; <=

;; @@
(plt/list-plot (combine-observes-fn (sample-observes-from-prior dirichlet-process-mixture-stick-breaking [(repeat 8 nil)])))
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"45702b23-01ed-40c3-be23-d12485d2b3fc","values":[{"x":0,"y":0.0},{"x":1,"y":0.0},{"x":2,"y":0.0},{"x":3,"y":0.5},{"x":4,"y":0.0},{"x":5,"y":0.0},{"x":6,"y":0.0},{"x":7,"y":0.0},{"x":8,"y":0.0},{"x":9,"y":0.0},{"x":10,"y":0.0},{"x":11,"y":0.0},{"x":12,"y":0.0},{"x":13,"y":0.5},{"x":14,"y":0.0},{"x":15,"y":0.0},{"x":16,"y":0.0},{"x":17,"y":0.0},{"x":18,"y":0.5},{"x":19,"y":0.5},{"x":20,"y":1.0},{"x":21,"y":0.0},{"x":22,"y":0.0},{"x":23,"y":0.0},{"x":24,"y":0.0},{"x":25,"y":0.0},{"x":26,"y":0.0},{"x":27,"y":0.0},{"x":28,"y":0.0},{"x":29,"y":0.0}]}],"marks":[{"type":"symbol","from":{"data":"45702b23-01ed-40c3-be23-d12485d2b3fc"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"45702b23-01ed-40c3-be23-d12485d2b3fc","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"45702b23-01ed-40c3-be23-d12485d2b3fc","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"45702b23-01ed-40c3-be23-d12485d2b3fc\", :values ({:x 0, :y 0.0} {:x 1, :y 0.0} {:x 2, :y 0.0} {:x 3, :y 0.5} {:x 4, :y 0.0} {:x 5, :y 0.0} {:x 6, :y 0.0} {:x 7, :y 0.0} {:x 8, :y 0.0} {:x 9, :y 0.0} {:x 10, :y 0.0} {:x 11, :y 0.0} {:x 12, :y 0.0} {:x 13, :y 0.5} {:x 14, :y 0.0} {:x 15, :y 0.0} {:x 16, :y 0.0} {:x 17, :y 0.0} {:x 18, :y 0.5} {:x 19, :y 0.5} {:x 20, :y 1.0} {:x 21, :y 0.0} {:x 22, :y 0.0} {:x 23, :y 0.0} {:x 24, :y 0.0} {:x 25, :y 0.0} {:x 26, :y 0.0} {:x 27, :y 0.0} {:x 28, :y 0.0} {:x 29, :y 0.0})}], :marks [{:type \"symbol\", :from {:data \"45702b23-01ed-40c3-be23-d12485d2b3fc\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"45702b23-01ed-40c3-be23-d12485d2b3fc\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"45702b23-01ed-40c3-be23-d12485d2b3fc\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(def replier (zmq/start-replier dirichlet-process-mixture-stick-breaking [(repeat 8 nil)] combine-observes-fn))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/replier</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/replier"}
;; <=

;; @@
(zmq/stop-replier replier)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-string'>&quot;ZMQ connection terminated.&quot;</span>","value":"\"ZMQ connection terminated.\""}
;; <=

;; **
;;; ## Inference
;; **

;; @@
(def test-observations
  [-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
   7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
   3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3])

(def test-observations
  [-4 -4 -4 -4 4 4 4 4])

(def test-observations
  [1.45 1 0.9 2.5 17.8 18.2 17.9 17.8])
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;worksheets.dirichlet-process-mixture-stick-breaking/test-observations</span>","value":"#'worksheets.dirichlet-process-mixture-stick-breaking/test-observations"}
;; <=

;; @@
(def num-particles 1000)
(def csis-states (take num-particles (infer :csis dirichlet-process-mixture-stick-breaking [test-observations]
                                            :observe-embedder-input (gridify (move-to-unit-box (map #(/ % 50) test-observations)) [30]))))
(plt/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results csis-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"41984b7e-2aa5-40a3-9ee7-bc0354dcc307","values":[{"x":-0.24403251354413436,"y":0},{"x":0.7559674864558656,"y":1.0}]}],"marks":[{"type":"line","from":{"data":"41984b7e-2aa5-40a3-9ee7-bc0354dcc307"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"41984b7e-2aa5-40a3-9ee7-bc0354dcc307","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"41984b7e-2aa5-40a3-9ee7-bc0354dcc307","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"41984b7e-2aa5-40a3-9ee7-bc0354dcc307\", :values ({:x -0.24403251354413436, :y 0} {:x 0.7559674864558656, :y 1.0})}], :marks [{:type \"line\", :from {:data \"41984b7e-2aa5-40a3-9ee7-bc0354dcc307\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"41984b7e-2aa5-40a3-9ee7-bc0354dcc307\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"41984b7e-2aa5-40a3-9ee7-bc0354dcc307\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(def num-particles 1000)
(def is-states (take num-particles (infer :importance dirichlet-process-mixture-stick-breaking [test-observations])))
(plt/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results is-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"d4986d19-f0e9-46ea-bd03-80a589eed1c9","values":[{"x":-19.169440043409878,"y":0},{"x":-18.790036775086147,"y":0.8434297401121926},{"x":-18.410633506762416,"y":0.0},{"x":-18.031230238438685,"y":0.0},{"x":-17.651826970114953,"y":0.0},{"x":-17.272423701791222,"y":0.0},{"x":-16.89302043346749,"y":0.0},{"x":-16.51361716514376,"y":0.0},{"x":-16.13421389682003,"y":0.0},{"x":-15.7548106284963,"y":0.0},{"x":-15.37540736017257,"y":0.0},{"x":-14.99600409184884,"y":0.0},{"x":-14.616600823525111,"y":0.0},{"x":-14.237197555201382,"y":0.0},{"x":-13.857794286877652,"y":0.0},{"x":-13.478391018553923,"y":0.0},{"x":-13.098987750230194,"y":0.0},{"x":-12.719584481906464,"y":0.0},{"x":-12.340181213582735,"y":0.0},{"x":-11.960777945259006,"y":0.0},{"x":-11.581374676935276,"y":0.0},{"x":-11.201971408611547,"y":0.0},{"x":-10.822568140287817,"y":0.0},{"x":-10.443164871964088,"y":0.0},{"x":-10.063761603640359,"y":0.0},{"x":-9.68435833531663,"y":0.0},{"x":-9.3049550669929,"y":0.0},{"x":-8.92555179866917,"y":0.0},{"x":-8.546148530345441,"y":0.0},{"x":-8.166745262021712,"y":0.0},{"x":-7.787341993697981,"y":0.0},{"x":-7.407938725374251,"y":0.0},{"x":-7.028535457050521,"y":0.0},{"x":-6.6491321887267905,"y":0.0},{"x":-6.26972892040306,"y":0.0},{"x":-5.89032565207933,"y":0.0},{"x":-5.5109223837556,"y":0.0},{"x":-5.131519115431869,"y":0.0},{"x":-4.752115847108139,"y":0.0},{"x":-4.372712578784409,"y":0.0},{"x":-3.993309310460679,"y":0.0},{"x":-3.613906042136949,"y":0.0},{"x":-3.2345027738132193,"y":0.0},{"x":-2.8550995054894894,"y":0.0},{"x":-2.4756962371657596,"y":0.0},{"x":-2.0962929688420298,"y":0.0},{"x":-1.7168897005183,"y":0.0},{"x":-1.33748643219457,"y":0.0},{"x":-0.9580831638708402,"y":0.0},{"x":-0.5786798955471104,"y":0.0},{"x":-0.19927662722338052,"y":0.0},{"x":0.18012664110034937,"y":0.0},{"x":0.5595299094240793,"y":0.0},{"x":0.9389331777478092,"y":0.002635717937850602},{"x":1.318336446071539,"y":0.018450025564954214},{"x":1.6977397143952688,"y":0.0},{"x":2.077142982718999,"y":0.0},{"x":2.4565462510427287,"y":0.0},{"x":2.8359495193664586,"y":0.0},{"x":3.2153527876901884,"y":0.0},{"x":3.5947560560139182,"y":0.0},{"x":3.974159324337648,"y":1.7632953004220528},{"x":4.353562592661378,"y":0.0},{"x":4.732965860985108,"y":0.0},{"x":5.1123691293088385,"y":0.0},{"x":5.491772397632569,"y":0.0},{"x":5.871175665956299,"y":0.0},{"x":6.250578934280029,"y":0.0},{"x":6.62998220260376,"y":0.0},{"x":7.00938547092749,"y":0.0},{"x":7.38878873925122,"y":0.0},{"x":7.76819200757495,"y":0.0},{"x":8.14759527589868,"y":0.0},{"x":8.52699854422241,"y":0.0},{"x":8.90640181254614,"y":0.0},{"x":9.285805080869869,"y":0.0},{"x":9.665208349193598,"y":0.0},{"x":10.044611617517328,"y":0.0},{"x":10.424014885841057,"y":0.0},{"x":10.803418154164786,"y":0.0},{"x":11.182821422488516,"y":0.0},{"x":11.562224690812245,"y":0.0},{"x":11.941627959135975,"y":0.005271435875701204},{"x":12.321031227459704,"y":0.0},{"x":12.700434495783433,"y":0.0},{"x":13.079837764107163,"y":0.0},{"x":13.459241032430892,"y":0.0},{"x":13.838644300754622,"y":0.0},{"x":14.218047569078351,"y":0.0},{"x":14.59745083740208,"y":0.0},{"x":14.97685410572581,"y":0.0},{"x":15.35625737404954,"y":0.0},{"x":15.735660642373269,"y":0.0},{"x":16.115063910697,"y":0.0},{"x":16.49446717902073,"y":0.0},{"x":16.873870447344462,"y":0.0},{"x":17.253273715668193,"y":0.0},{"x":17.632676983991924,"y":0.0},{"x":18.012080252315656,"y":0.0},{"x":18.391483520639387,"y":0.0},{"x":18.770886788963118,"y":0.002635717937850602},{"x":19.15029005728685,"y":0}]}],"marks":[{"type":"line","from":{"data":"d4986d19-f0e9-46ea-bd03-80a589eed1c9"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"d4986d19-f0e9-46ea-bd03-80a589eed1c9","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"d4986d19-f0e9-46ea-bd03-80a589eed1c9","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"d4986d19-f0e9-46ea-bd03-80a589eed1c9\", :values ({:x -19.169440043409878, :y 0} {:x -18.790036775086147, :y 0.8434297401121926} {:x -18.410633506762416, :y 0.0} {:x -18.031230238438685, :y 0.0} {:x -17.651826970114953, :y 0.0} {:x -17.272423701791222, :y 0.0} {:x -16.89302043346749, :y 0.0} {:x -16.51361716514376, :y 0.0} {:x -16.13421389682003, :y 0.0} {:x -15.7548106284963, :y 0.0} {:x -15.37540736017257, :y 0.0} {:x -14.99600409184884, :y 0.0} {:x -14.616600823525111, :y 0.0} {:x -14.237197555201382, :y 0.0} {:x -13.857794286877652, :y 0.0} {:x -13.478391018553923, :y 0.0} {:x -13.098987750230194, :y 0.0} {:x -12.719584481906464, :y 0.0} {:x -12.340181213582735, :y 0.0} {:x -11.960777945259006, :y 0.0} {:x -11.581374676935276, :y 0.0} {:x -11.201971408611547, :y 0.0} {:x -10.822568140287817, :y 0.0} {:x -10.443164871964088, :y 0.0} {:x -10.063761603640359, :y 0.0} {:x -9.68435833531663, :y 0.0} {:x -9.3049550669929, :y 0.0} {:x -8.92555179866917, :y 0.0} {:x -8.546148530345441, :y 0.0} {:x -8.166745262021712, :y 0.0} {:x -7.787341993697981, :y 0.0} {:x -7.407938725374251, :y 0.0} {:x -7.028535457050521, :y 0.0} {:x -6.6491321887267905, :y 0.0} {:x -6.26972892040306, :y 0.0} {:x -5.89032565207933, :y 0.0} {:x -5.5109223837556, :y 0.0} {:x -5.131519115431869, :y 0.0} {:x -4.752115847108139, :y 0.0} {:x -4.372712578784409, :y 0.0} {:x -3.993309310460679, :y 0.0} {:x -3.613906042136949, :y 0.0} {:x -3.2345027738132193, :y 0.0} {:x -2.8550995054894894, :y 0.0} {:x -2.4756962371657596, :y 0.0} {:x -2.0962929688420298, :y 0.0} {:x -1.7168897005183, :y 0.0} {:x -1.33748643219457, :y 0.0} {:x -0.9580831638708402, :y 0.0} {:x -0.5786798955471104, :y 0.0} {:x -0.19927662722338052, :y 0.0} {:x 0.18012664110034937, :y 0.0} {:x 0.5595299094240793, :y 0.0} {:x 0.9389331777478092, :y 0.002635717937850602} {:x 1.318336446071539, :y 0.018450025564954214} {:x 1.6977397143952688, :y 0.0} {:x 2.077142982718999, :y 0.0} {:x 2.4565462510427287, :y 0.0} {:x 2.8359495193664586, :y 0.0} {:x 3.2153527876901884, :y 0.0} {:x 3.5947560560139182, :y 0.0} {:x 3.974159324337648, :y 1.7632953004220528} {:x 4.353562592661378, :y 0.0} {:x 4.732965860985108, :y 0.0} {:x 5.1123691293088385, :y 0.0} {:x 5.491772397632569, :y 0.0} {:x 5.871175665956299, :y 0.0} {:x 6.250578934280029, :y 0.0} {:x 6.62998220260376, :y 0.0} {:x 7.00938547092749, :y 0.0} {:x 7.38878873925122, :y 0.0} {:x 7.76819200757495, :y 0.0} {:x 8.14759527589868, :y 0.0} {:x 8.52699854422241, :y 0.0} {:x 8.90640181254614, :y 0.0} {:x 9.285805080869869, :y 0.0} {:x 9.665208349193598, :y 0.0} {:x 10.044611617517328, :y 0.0} {:x 10.424014885841057, :y 0.0} {:x 10.803418154164786, :y 0.0} {:x 11.182821422488516, :y 0.0} {:x 11.562224690812245, :y 0.0} {:x 11.941627959135975, :y 0.005271435875701204} {:x 12.321031227459704, :y 0.0} {:x 12.700434495783433, :y 0.0} {:x 13.079837764107163, :y 0.0} {:x 13.459241032430892, :y 0.0} {:x 13.838644300754622, :y 0.0} {:x 14.218047569078351, :y 0.0} {:x 14.59745083740208, :y 0.0} {:x 14.97685410572581, :y 0.0} {:x 15.35625737404954, :y 0.0} {:x 15.735660642373269, :y 0.0} {:x 16.115063910697, :y 0.0} {:x 16.49446717902073, :y 0.0} {:x 16.873870447344462, :y 0.0} {:x 17.253273715668193, :y 0.0} {:x 17.632676983991924, :y 0.0} {:x 18.012080252315656, :y 0.0} {:x 18.391483520639387, :y 0.0} {:x 18.770886788963118, :y 0.002635717937850602} {:x 19.15029005728685, :y 0})}], :marks [{:type \"line\", :from {:data \"d4986d19-f0e9-46ea-bd03-80a589eed1c9\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"d4986d19-f0e9-46ea-bd03-80a589eed1c9\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"d4986d19-f0e9-46ea-bd03-80a589eed1c9\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(def num-particles 1000)
(def smc-states (take num-particles (infer :smc dirichlet-process-mixture-stick-breaking [test-observations] :number-of-particles 100)))
(plt/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results smc-states)))))) :normalize :probability-density :bins 100)
;; @@

;; **
;;; ## stuff...
;; **

;; @@
(defquery dirichlet-process-mixture-stick-breaking-prior
  [input-data]
  (let
    [concentration 1.72
     base (fn []
            (let [v (/ 1.0 (sample (gamma 1 10)))]
              (list (sample (normal 0 (sqrt (* v 10)))) 
                    (sqrt v))))
     obs-param (DPmem concentration base)]

    ; observe draws from the DP mixture
    #_(map
      (fn [value]
        (observe (apply normal (obs-param)) value))
      input-data)

    ; predict a data point from the DP mixture
    (sample (apply normal (obs-param)))))

(def num-particles 1000)
(def smc-states (take num-particles (infer :smc dirichlet-process-mixture-stick-breaking-prior [test-observations] :number-of-particles 100)))
(plt/histogram (repeatedly 1000 #(sample* (categorical (vec (empirical-distribution (collect-results smc-states)))))) :normalize :probability-density :bins 100)
;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"36f12138-60c2-4d7b-a9fe-5b039bbb1604","values":[{"x":-155.7143839474302,"y":0},{"x":-151.3724301791135,"y":9.2124426316744E-4},{"x":-147.0304764107968,"y":0.0},{"x":-142.6885226424801,"y":0.0},{"x":-138.3465688741634,"y":0.0},{"x":-134.0046151058467,"y":0.0},{"x":-129.66266133753,"y":0.0},{"x":-125.32070756921331,"y":0.0},{"x":-120.97875380089661,"y":0.0},{"x":-116.63680003257991,"y":0.0},{"x":-112.29484626426321,"y":0.0},{"x":-107.95289249594651,"y":2.3031106579186E-4},{"x":-103.61093872762982,"y":0.0},{"x":-99.26898495931312,"y":0.0},{"x":-94.92703119099642,"y":0.0},{"x":-90.58507742267972,"y":0.0},{"x":-86.24312365436302,"y":2.3031106579186E-4},{"x":-81.90116988604632,"y":2.3031106579186E-4},{"x":-77.55921611772962,"y":4.6062213158372E-4},{"x":-73.21726234941292,"y":0.0},{"x":-68.87530858109622,"y":4.6062213158372E-4},{"x":-64.53335481277952,"y":2.3031106579186E-4},{"x":-60.19140104446283,"y":2.3031106579186E-4},{"x":-55.84944727614614,"y":4.6062213158372E-4},{"x":-51.507493507829444,"y":4.6062213158372E-4},{"x":-47.16553973951275,"y":0.00161217746054302},{"x":-42.82358597119606,"y":2.3031106579186E-4},{"x":-38.48163220287937,"y":4.6062213158372E-4},{"x":-34.139678434562676,"y":0.00276373278950232},{"x":-29.797724666245983,"y":0.0025334217237104597},{"x":-25.45577089792929,"y":0.00184248852633488},{"x":-21.1138171296126,"y":0.00875182050009068},{"x":-16.771863361295907,"y":0.007600265171131379},{"x":-12.429909592979214,"y":0.01635208567122206},{"x":-8.087955824662522,"y":0.019806751658099957},{"x":-3.74600205634583,"y":0.026716083631855757},{"x":0.5959517119708622,"y":0.034776970934570856},{"x":4.937905480287554,"y":0.0299404385529418},{"x":9.279859248604247,"y":0.02164924018443484},{"x":13.621813016920939,"y":0.01888550739493252},{"x":17.96376678523763,"y":0.008060887302715099},{"x":22.305720553554323,"y":0.006679020907963939},{"x":26.647674321871015,"y":0.0025334217237104597},{"x":30.989628090187708,"y":0.0029940438552941797},{"x":35.3315818585044,"y":0.0023031106579186},{"x":39.67353562682109,"y":6.9093319737558E-4},{"x":44.015489395137784,"y":0.0025334217237104597},{"x":48.35744316345448,"y":6.9093319737558E-4},{"x":52.69939693177117,"y":4.6062213158372E-4},{"x":57.04135070008786,"y":6.9093319737558E-4},{"x":61.38330446840455,"y":4.6062213158372E-4},{"x":65.72525823672125,"y":6.9093319737558E-4},{"x":70.06721200503793,"y":0.0},{"x":74.40916577335463,"y":4.6062213158372E-4},{"x":78.75111954167133,"y":6.9093319737558E-4},{"x":83.09307330998803,"y":0.0011515553289593},{"x":87.43502707830473,"y":0.0},{"x":91.77698084662143,"y":0.0},{"x":96.11893461493813,"y":2.3031106579186E-4},{"x":100.46088838325483,"y":0.0},{"x":104.80284215157153,"y":0.0},{"x":109.14479591988822,"y":0.0},{"x":113.48674968820492,"y":0.0},{"x":117.82870345652162,"y":0.0},{"x":122.17065722483832,"y":0.0},{"x":126.51261099315502,"y":0.0},{"x":130.85456476147172,"y":9.2124426316744E-4},{"x":135.19651852978842,"y":0.0},{"x":139.53847229810512,"y":0.0},{"x":143.88042606642182,"y":0.0},{"x":148.22237983473852,"y":0.0},{"x":152.56433360305522,"y":0.0},{"x":156.90628737137192,"y":0.0},{"x":161.24824113968862,"y":0.0},{"x":165.59019490800532,"y":0.0},{"x":169.93214867632202,"y":0.0},{"x":174.27410244463871,"y":0.0},{"x":178.6160562129554,"y":0.0},{"x":182.9580099812721,"y":0.0},{"x":187.2999637495888,"y":0.0},{"x":191.6419175179055,"y":0.0},{"x":195.9838712862222,"y":0.0},{"x":200.3258250545389,"y":0.0},{"x":204.6677788228556,"y":0.0},{"x":209.0097325911723,"y":0.0},{"x":213.351686359489,"y":0.0},{"x":217.6936401278057,"y":0.0},{"x":222.0355938961224,"y":0.0},{"x":226.3775476644391,"y":0.0},{"x":230.7195014327558,"y":0.0},{"x":235.0614552010725,"y":0.0},{"x":239.4034089693892,"y":0.0},{"x":243.7453627377059,"y":0.0},{"x":248.0873165060226,"y":0.0},{"x":252.4292702743393,"y":0.0},{"x":256.771224042656,"y":0.0},{"x":261.1131778109727,"y":0.0},{"x":265.45513157928934,"y":0.0},{"x":269.797085347606,"y":0.0},{"x":274.1390391159227,"y":0.0},{"x":278.48099288423936,"y":2.3031106579186E-4},{"x":282.822946652556,"y":0}]}],"marks":[{"type":"line","from":{"data":"36f12138-60c2-4d7b-a9fe-5b039bbb1604"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"36f12138-60c2-4d7b-a9fe-5b039bbb1604","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"36f12138-60c2-4d7b-a9fe-5b039bbb1604","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\", :values ({:x -155.7143839474302, :y 0} {:x -151.3724301791135, :y 9.2124426316744E-4} {:x -147.0304764107968, :y 0.0} {:x -142.6885226424801, :y 0.0} {:x -138.3465688741634, :y 0.0} {:x -134.0046151058467, :y 0.0} {:x -129.66266133753, :y 0.0} {:x -125.32070756921331, :y 0.0} {:x -120.97875380089661, :y 0.0} {:x -116.63680003257991, :y 0.0} {:x -112.29484626426321, :y 0.0} {:x -107.95289249594651, :y 2.3031106579186E-4} {:x -103.61093872762982, :y 0.0} {:x -99.26898495931312, :y 0.0} {:x -94.92703119099642, :y 0.0} {:x -90.58507742267972, :y 0.0} {:x -86.24312365436302, :y 2.3031106579186E-4} {:x -81.90116988604632, :y 2.3031106579186E-4} {:x -77.55921611772962, :y 4.6062213158372E-4} {:x -73.21726234941292, :y 0.0} {:x -68.87530858109622, :y 4.6062213158372E-4} {:x -64.53335481277952, :y 2.3031106579186E-4} {:x -60.19140104446283, :y 2.3031106579186E-4} {:x -55.84944727614614, :y 4.6062213158372E-4} {:x -51.507493507829444, :y 4.6062213158372E-4} {:x -47.16553973951275, :y 0.00161217746054302} {:x -42.82358597119606, :y 2.3031106579186E-4} {:x -38.48163220287937, :y 4.6062213158372E-4} {:x -34.139678434562676, :y 0.00276373278950232} {:x -29.797724666245983, :y 0.0025334217237104597} {:x -25.45577089792929, :y 0.00184248852633488} {:x -21.1138171296126, :y 0.00875182050009068} {:x -16.771863361295907, :y 0.007600265171131379} {:x -12.429909592979214, :y 0.01635208567122206} {:x -8.087955824662522, :y 0.019806751658099957} {:x -3.74600205634583, :y 0.026716083631855757} {:x 0.5959517119708622, :y 0.034776970934570856} {:x 4.937905480287554, :y 0.0299404385529418} {:x 9.279859248604247, :y 0.02164924018443484} {:x 13.621813016920939, :y 0.01888550739493252} {:x 17.96376678523763, :y 0.008060887302715099} {:x 22.305720553554323, :y 0.006679020907963939} {:x 26.647674321871015, :y 0.0025334217237104597} {:x 30.989628090187708, :y 0.0029940438552941797} {:x 35.3315818585044, :y 0.0023031106579186} {:x 39.67353562682109, :y 6.9093319737558E-4} {:x 44.015489395137784, :y 0.0025334217237104597} {:x 48.35744316345448, :y 6.9093319737558E-4} {:x 52.69939693177117, :y 4.6062213158372E-4} {:x 57.04135070008786, :y 6.9093319737558E-4} {:x 61.38330446840455, :y 4.6062213158372E-4} {:x 65.72525823672125, :y 6.9093319737558E-4} {:x 70.06721200503793, :y 0.0} {:x 74.40916577335463, :y 4.6062213158372E-4} {:x 78.75111954167133, :y 6.9093319737558E-4} {:x 83.09307330998803, :y 0.0011515553289593} {:x 87.43502707830473, :y 0.0} {:x 91.77698084662143, :y 0.0} {:x 96.11893461493813, :y 2.3031106579186E-4} {:x 100.46088838325483, :y 0.0} {:x 104.80284215157153, :y 0.0} {:x 109.14479591988822, :y 0.0} {:x 113.48674968820492, :y 0.0} {:x 117.82870345652162, :y 0.0} {:x 122.17065722483832, :y 0.0} {:x 126.51261099315502, :y 0.0} {:x 130.85456476147172, :y 9.2124426316744E-4} {:x 135.19651852978842, :y 0.0} {:x 139.53847229810512, :y 0.0} {:x 143.88042606642182, :y 0.0} {:x 148.22237983473852, :y 0.0} {:x 152.56433360305522, :y 0.0} {:x 156.90628737137192, :y 0.0} {:x 161.24824113968862, :y 0.0} {:x 165.59019490800532, :y 0.0} {:x 169.93214867632202, :y 0.0} {:x 174.27410244463871, :y 0.0} {:x 178.6160562129554, :y 0.0} {:x 182.9580099812721, :y 0.0} {:x 187.2999637495888, :y 0.0} {:x 191.6419175179055, :y 0.0} {:x 195.9838712862222, :y 0.0} {:x 200.3258250545389, :y 0.0} {:x 204.6677788228556, :y 0.0} {:x 209.0097325911723, :y 0.0} {:x 213.351686359489, :y 0.0} {:x 217.6936401278057, :y 0.0} {:x 222.0355938961224, :y 0.0} {:x 226.3775476644391, :y 0.0} {:x 230.7195014327558, :y 0.0} {:x 235.0614552010725, :y 0.0} {:x 239.4034089693892, :y 0.0} {:x 243.7453627377059, :y 0.0} {:x 248.0873165060226, :y 0.0} {:x 252.4292702743393, :y 0.0} {:x 256.771224042656, :y 0.0} {:x 261.1131778109727, :y 0.0} {:x 265.45513157928934, :y 0.0} {:x 269.797085347606, :y 0.0} {:x 274.1390391159227, :y 0.0} {:x 278.48099288423936, :y 2.3031106579186E-4} {:x 282.822946652556, :y 0})}], :marks [{:type \"line\", :from {:data \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"36f12138-60c2-4d7b-a9fe-5b039bbb1604\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(def input-data
  (list -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
        7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7
        3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3))

(def samples
  (take 5000
             (doquery :smc
                      dirichlet-process-mixture-stick-breaking
                      [input-data]
                      :number-of-particles 100)))

(def predictions (map :result samples))

(plt/histogram predictions :bins 100 :plot-range [[-8 15] :all])

;; @@
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"fa231430-02c6-43fb-871b-55d1465f36bd","values":[{"x":-8.0,"y":0},{"x":-7.77,"y":0.0},{"x":-7.539999999999999,"y":0.0},{"x":-7.309999999999999,"y":2.0},{"x":-7.079999999999998,"y":3.0},{"x":-6.849999999999998,"y":1.0},{"x":-6.619999999999997,"y":1.0},{"x":-6.389999999999997,"y":3.0},{"x":-6.159999999999997,"y":1.0},{"x":-5.929999999999996,"y":3.0},{"x":-5.699999999999996,"y":3.0},{"x":-5.469999999999995,"y":4.0},{"x":-5.239999999999995,"y":4.0},{"x":-5.0099999999999945,"y":1.0},{"x":-4.779999999999994,"y":7.0},{"x":-4.549999999999994,"y":8.0},{"x":-4.319999999999993,"y":5.0},{"x":-4.089999999999993,"y":6.0},{"x":-3.8599999999999928,"y":4.0},{"x":-3.629999999999993,"y":5.0},{"x":-3.399999999999993,"y":8.0},{"x":-3.169999999999993,"y":8.0},{"x":-2.939999999999993,"y":5.0},{"x":-2.709999999999993,"y":9.0},{"x":-2.479999999999993,"y":15.0},{"x":-2.249999999999993,"y":22.0},{"x":-2.019999999999993,"y":20.0},{"x":-1.789999999999993,"y":29.0},{"x":-1.559999999999993,"y":89.0},{"x":-1.329999999999993,"y":220.0},{"x":-1.099999999999993,"y":549.0},{"x":-0.869999999999993,"y":805.0},{"x":-0.639999999999993,"y":596.0},{"x":-0.40999999999999304,"y":252.0},{"x":-0.17999999999999303,"y":130.0},{"x":0.05000000000000698,"y":60.0},{"x":0.280000000000007,"y":53.0},{"x":0.510000000000007,"y":36.0},{"x":0.740000000000007,"y":34.0},{"x":0.970000000000007,"y":41.0},{"x":1.200000000000007,"y":37.0},{"x":1.430000000000007,"y":38.0},{"x":1.660000000000007,"y":32.0},{"x":1.890000000000007,"y":35.0},{"x":2.120000000000007,"y":50.0},{"x":2.350000000000007,"y":70.0},{"x":2.580000000000007,"y":91.0},{"x":2.810000000000007,"y":115.0},{"x":3.040000000000007,"y":126.0},{"x":3.270000000000007,"y":133.0},{"x":3.500000000000007,"y":83.0},{"x":3.730000000000007,"y":59.0},{"x":3.960000000000007,"y":45.0},{"x":4.1900000000000075,"y":32.0},{"x":4.420000000000008,"y":18.0},{"x":4.650000000000008,"y":23.0},{"x":4.880000000000009,"y":24.0},{"x":5.110000000000009,"y":32.0},{"x":5.34000000000001,"y":20.0},{"x":5.57000000000001,"y":29.0},{"x":5.8000000000000105,"y":46.0},{"x":6.030000000000011,"y":45.0},{"x":6.260000000000011,"y":63.0},{"x":6.490000000000012,"y":68.0},{"x":6.720000000000012,"y":74.0},{"x":6.950000000000013,"y":103.0},{"x":7.180000000000013,"y":78.0},{"x":7.4100000000000135,"y":74.0},{"x":7.640000000000014,"y":66.0},{"x":7.870000000000014,"y":42.0},{"x":8.100000000000014,"y":37.0},{"x":8.330000000000014,"y":34.0},{"x":8.560000000000015,"y":22.0},{"x":8.790000000000015,"y":15.0},{"x":9.020000000000016,"y":15.0},{"x":9.250000000000016,"y":12.0},{"x":9.480000000000016,"y":11.0},{"x":9.710000000000017,"y":3.0},{"x":9.940000000000017,"y":6.0},{"x":10.170000000000018,"y":3.0},{"x":10.400000000000018,"y":5.0},{"x":10.630000000000019,"y":1.0},{"x":10.860000000000019,"y":2.0},{"x":11.09000000000002,"y":2.0},{"x":11.32000000000002,"y":3.0},{"x":11.55000000000002,"y":2.0},{"x":11.78000000000002,"y":0.0},{"x":12.010000000000021,"y":0.0},{"x":12.240000000000022,"y":2.0},{"x":12.470000000000022,"y":1.0},{"x":12.700000000000022,"y":1.0},{"x":12.930000000000023,"y":0.0},{"x":13.160000000000023,"y":2.0},{"x":13.390000000000024,"y":3.0},{"x":13.620000000000024,"y":1.0},{"x":13.850000000000025,"y":1.0},{"x":14.080000000000025,"y":0.0},{"x":14.310000000000025,"y":1.0},{"x":14.540000000000026,"y":0.0},{"x":14.770000000000026,"y":0.0},{"x":15.000000000000027,"y":0.0},{"x":15.230000000000027,"y":0}]}],"marks":[{"type":"line","from":{"data":"fa231430-02c6-43fb-871b-55d1465f36bd"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":[-8,15]},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"fa231430-02c6-43fb-871b-55d1465f36bd","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"fa231430-02c6-43fb-871b-55d1465f36bd\", :values ({:x -8.0, :y 0} {:x -7.77, :y 0.0} {:x -7.539999999999999, :y 0.0} {:x -7.309999999999999, :y 2.0} {:x -7.079999999999998, :y 3.0} {:x -6.849999999999998, :y 1.0} {:x -6.619999999999997, :y 1.0} {:x -6.389999999999997, :y 3.0} {:x -6.159999999999997, :y 1.0} {:x -5.929999999999996, :y 3.0} {:x -5.699999999999996, :y 3.0} {:x -5.469999999999995, :y 4.0} {:x -5.239999999999995, :y 4.0} {:x -5.0099999999999945, :y 1.0} {:x -4.779999999999994, :y 7.0} {:x -4.549999999999994, :y 8.0} {:x -4.319999999999993, :y 5.0} {:x -4.089999999999993, :y 6.0} {:x -3.8599999999999928, :y 4.0} {:x -3.629999999999993, :y 5.0} {:x -3.399999999999993, :y 8.0} {:x -3.169999999999993, :y 8.0} {:x -2.939999999999993, :y 5.0} {:x -2.709999999999993, :y 9.0} {:x -2.479999999999993, :y 15.0} {:x -2.249999999999993, :y 22.0} {:x -2.019999999999993, :y 20.0} {:x -1.789999999999993, :y 29.0} {:x -1.559999999999993, :y 89.0} {:x -1.329999999999993, :y 220.0} {:x -1.099999999999993, :y 549.0} {:x -0.869999999999993, :y 805.0} {:x -0.639999999999993, :y 596.0} {:x -0.40999999999999304, :y 252.0} {:x -0.17999999999999303, :y 130.0} {:x 0.05000000000000698, :y 60.0} {:x 0.280000000000007, :y 53.0} {:x 0.510000000000007, :y 36.0} {:x 0.740000000000007, :y 34.0} {:x 0.970000000000007, :y 41.0} {:x 1.200000000000007, :y 37.0} {:x 1.430000000000007, :y 38.0} {:x 1.660000000000007, :y 32.0} {:x 1.890000000000007, :y 35.0} {:x 2.120000000000007, :y 50.0} {:x 2.350000000000007, :y 70.0} {:x 2.580000000000007, :y 91.0} {:x 2.810000000000007, :y 115.0} {:x 3.040000000000007, :y 126.0} {:x 3.270000000000007, :y 133.0} {:x 3.500000000000007, :y 83.0} {:x 3.730000000000007, :y 59.0} {:x 3.960000000000007, :y 45.0} {:x 4.1900000000000075, :y 32.0} {:x 4.420000000000008, :y 18.0} {:x 4.650000000000008, :y 23.0} {:x 4.880000000000009, :y 24.0} {:x 5.110000000000009, :y 32.0} {:x 5.34000000000001, :y 20.0} {:x 5.57000000000001, :y 29.0} {:x 5.8000000000000105, :y 46.0} {:x 6.030000000000011, :y 45.0} {:x 6.260000000000011, :y 63.0} {:x 6.490000000000012, :y 68.0} {:x 6.720000000000012, :y 74.0} {:x 6.950000000000013, :y 103.0} {:x 7.180000000000013, :y 78.0} {:x 7.4100000000000135, :y 74.0} {:x 7.640000000000014, :y 66.0} {:x 7.870000000000014, :y 42.0} {:x 8.100000000000014, :y 37.0} {:x 8.330000000000014, :y 34.0} {:x 8.560000000000015, :y 22.0} {:x 8.790000000000015, :y 15.0} {:x 9.020000000000016, :y 15.0} {:x 9.250000000000016, :y 12.0} {:x 9.480000000000016, :y 11.0} {:x 9.710000000000017, :y 3.0} {:x 9.940000000000017, :y 6.0} {:x 10.170000000000018, :y 3.0} {:x 10.400000000000018, :y 5.0} {:x 10.630000000000019, :y 1.0} {:x 10.860000000000019, :y 2.0} {:x 11.09000000000002, :y 2.0} {:x 11.32000000000002, :y 3.0} {:x 11.55000000000002, :y 2.0} {:x 11.78000000000002, :y 0.0} {:x 12.010000000000021, :y 0.0} {:x 12.240000000000022, :y 2.0} {:x 12.470000000000022, :y 1.0} {:x 12.700000000000022, :y 1.0} {:x 12.930000000000023, :y 0.0} {:x 13.160000000000023, :y 2.0} {:x 13.390000000000024, :y 3.0} {:x 13.620000000000024, :y 1.0} {:x 13.850000000000025, :y 1.0} {:x 14.080000000000025, :y 0.0} {:x 14.310000000000025, :y 1.0} {:x 14.540000000000026, :y 0.0} {:x 14.770000000000026, :y 0.0} {:x 15.000000000000027, :y 0.0} {:x 15.230000000000027, :y 0})}], :marks [{:type \"line\", :from {:data \"fa231430-02c6-43fb-871b-55d1465f36bd\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain [-8 15]} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"fa231430-02c6-43fb-871b-55d1465f36bd\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@

;; @@
